default:
  tags:
    - gitlab-org
  before_script:
    - echo "build --disk_cache=$CI_PROJECT_DIR/.cache" >> .bazelrc
    - echo "build --verbose_failures" >> .bazelrc
    - echo "build --curses=no" >> .bazelrc
    - echo "build --show_timestamps" >> .bazelrc
    - echo "test --test_output=all" >> .bazelrc
    - echo "test --test_arg=-test.v" >> .bazelrc
#    - echo "build --sandbox_base=/dev/shm" >> .bazelrc # disabled because it's not big enough

variables:
  # must use image digest to invalidate cache if image is updated. Equivalent of tag "3.3.0" is used below.
  BUILD_IMAGE: "l.gcr.io/google/bazel@sha256:6877aad5229abb38c73973378ed8bf8642061cdf71a62d15ba507a4f7a4cc13a"

cache:
  key: "$BUILD_IMAGE"
  paths:
    - .cache/

test:
  stage: test
  image:
    name: "$BUILD_IMAGE"
    entrypoint: [""]
  script:
    - apt-get install -y make
    - make test-ci
